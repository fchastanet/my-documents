---
name: Build All Documentation Sites

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-docs-rebuild]
  push:
    branches: [master]
    paths:
      - 'content/**'
      - 'shared/**'
      - 'configs/**'
      - '.github/workflows/build-all-sites.yml'
  pull_request:

concurrency:
  group: build-all-sites
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - name: my-documents
            repo: fchastanet/my-documents
            baseURL: 'https://fchastanet.github.io/my-documents'
            self: true
          - name: bash-compiler
            repo: fchastanet/bash-compiler
            baseURL: 'https://fchastanet.github.io/bash-compiler'
            self: false
          - name: bash-tools
            repo: fchastanet/bash-tools
            baseURL: 'https://fchastanet.github.io/bash-tools'
            self: false
          - name: bash-tools-framework
            repo: fchastanet/bash-tools-framework
            baseURL: 'https://fchastanet.github.io/bash-tools-framework'
            self: false
          - name: bash-dev-env
            repo: fchastanet/bash-dev-env
            baseURL: 'https://fchastanet.github.io/bash-dev-env'
            self: false

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout my-documents (orchestrator)
        uses: actions/checkout@v4
        with:
          repository: fchastanet/my-documents
          path: orchestrator
          fetch-depth: 0

      - name: Checkout ${{ matrix.site.name }} content
        if: ${{ !matrix.site.self }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.site.repo }}
          path: sites/${{ matrix.site.name }}
          ref: master
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.155.3'
          extended: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install yq for YAML merging
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Prepare build for ${{ matrix.site.name }}
        run: |
          if [ "${{ matrix.site.self }}" = "true" ]; then
            BUILD_DIR="orchestrator"

            # For my-documents, merge its own config
            cd "$BUILD_DIR"
            yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
              configs/_base.yaml \
              configs/my-documents.yaml > hugo.yaml
            echo "âœ… Merged config for my-documents"
          else
            BUILD_DIR="build-${{ matrix.site.name }}"
            mkdir -p "$BUILD_DIR"

            echo "ðŸ“¦ Setting up ${{ matrix.site.name }}..."

            # Copy shared resources from orchestrator
            echo "  Copying shared layouts..."
            [ -d "orchestrator/shared/layouts" ] && cp -r orchestrator/shared/layouts "$BUILD_DIR/" || true
            echo "  Copying shared assets..."
            [ -d "orchestrator/shared/assets" ] && cp -r orchestrator/shared/assets "$BUILD_DIR/" || true
            echo "  Copying shared archetypes..."
            [ -d "orchestrator/shared/archetypes" ] && cp -r orchestrator/shared/archetypes "$BUILD_DIR/" || true

            # Copy site content
            echo "  Copying content..."
            cp -r sites/${{ matrix.site.name }}/content "$BUILD_DIR/"

            echo "  Copying static files..."
            [ -d "sites/${{ matrix.site.name }}/static" ] && cp -r sites/${{ matrix.site.name }}/static "$BUILD_DIR/" || true

            # Copy go.mod and go.sum if they exist
            [ -f "sites/${{ matrix.site.name }}/go.mod" ] && cp sites/${{ matrix.site.name }}/go.mod "$BUILD_DIR/" || true
            [ -f "sites/${{ matrix.site.name }}/go.sum" ] && cp sites/${{ matrix.site.name }}/go.sum "$BUILD_DIR/" || true

            # Merge configs using yq (proper YAML deep merge)
            echo "  Merging configurations..."
            yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
              orchestrator/configs/_base.yaml \
              orchestrator/configs/${{ matrix.site.name }}.yaml > "$BUILD_DIR/hugo.yaml"

            # Override baseURL (ensure trailing slash)
            yq eval -i ".baseURL = \"${{ matrix.site.baseURL }}/\"" "$BUILD_DIR/hugo.yaml"

            echo "âœ… Build directory prepared for ${{ matrix.site.name }}"
          fi
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: Initialize Go modules for ${{ matrix.site.name }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # Initialize go.mod if it doesn't exist
          if [ ! -f go.mod ]; then
            echo "Initializing Go module..."
            go mod init github.com/${{ matrix.site.repo }}
          fi

          # Download Hugo modules using Go
          echo "Downloading Hugo modules..."
          go get -u github.com/google/docsy@v0.14.2
          go get -u github.com/google/docsy/dependencies@v0.7.2
          go mod tidy

          echo "âœ… Go modules ready"

      - name: Build ${{ matrix.site.name }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          echo "ðŸ”¨ Building ${{ matrix.site.name }}..."
          hugo --minify \
            --baseURL "${{ matrix.site.baseURL }}/" \
            --printI18nWarnings \
            --printPathWarnings \
            --printUnusedTemplates \
            --logLevel info

          echo "âœ… Build complete for ${{ matrix.site.name }}"
          echo "ðŸ“Š Public directory size:"
          du -sh public/
        env:
          HUGO_ENVIRONMENT: production

      - name: Generate GitHub App token for ${{ matrix.site.name }}
        if: ${{ !matrix.site.self }}
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DOC_APP_ID }}
          private-key: ${{ secrets.DOC_APP_PRIVATE_KEY }}
          owner: fchastanet
          repositories: ${{ matrix.site.name }}

      - name: Deploy ${{ matrix.site.name }} to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ matrix.site.self && secrets.GITHUB_TOKEN || steps.app-token.outputs.token }}
          external_repository: ${{ !matrix.site.self && matrix.site.repo || '' }}
          publish_dir: ${{ env.BUILD_DIR }}/public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy ${{ matrix.site.name }} documentation'

      - name: Deployment summary
        run: |
          echo "### âœ… ${{ matrix.site.name }} deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL:** ${{ matrix.site.baseURL }}/" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Pages:** $(find ${{ env.BUILD_DIR }}/public -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Size:** $(du -sh ${{ env.BUILD_DIR }}/public | cut -f1)" >> $GITHUB_STEP_SUMMARY
