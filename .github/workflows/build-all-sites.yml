---
name: Build All Documentation Sites

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-docs-rebuild]
  push:
    branches: [master]
    paths:
      - 'content/**'
      - 'shared/**'
      - 'configs/**'
      - '.github/workflows/build-all-sites.yml'

concurrency:
  group: build-all-sites
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - name: my-documents
            repo: fchastanet/my-documents
            repoRoot: .
            baseURL: 'https://fchastanet.github.io/my-documents'
            self: true
          - name: bash-compiler
            repo: fchastanet/bash-compiler
            repoRoot: sites/bash-compiler
            baseURL: 'https://fchastanet.github.io/bash-compiler'
            self: false
          - name: bash-tools
            repo: fchastanet/bash-tools
            repoRoot: sites/bash-tools
            baseURL: 'https://fchastanet.github.io/bash-tools'
            self: false
          - name: bash-tools-framework
            repo: fchastanet/bash-tools-framework
            repoRoot: sites/bash-tools-framework
            baseURL: 'https://fchastanet.github.io/bash-tools-framework'
            self: false
          - name: bash-dev-env
            repo: fchastanet/bash-dev-env
            repoRoot: sites/bash-dev-env
            baseURL: 'https://fchastanet.github.io/bash-dev-env'
            self: false

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout my-documents (orchestrator)
        uses: actions/checkout@v6
        with:
          repository: fchastanet/my-documents
          fetch-depth: 0

      - name: Checkout ${{ matrix.site.name }} content
        if: ${{ !matrix.site.self }}
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.site.repo }}
          path: sites/${{ matrix.site.name }}
          ref: master
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.155.3'
          extended: true

      - name: Cache Hugo modules
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/hugo_modules
            go.mod
            go.sum
          key: ${{ runner.os }}-hugo-modules-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugo-modules-

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Dart Sass
        run: npm install -g sass

      - name: Setup yq
        uses: vegardit/gha-setup-yq@v1
        with:
          yq-version: v4.52.4

      - name: Prepare build for ${{ matrix.site.name }}
        run: |
          bash .github/scripts/build-site.sh \
            "${{ matrix.site.repoRoot }}" \
            "${{ matrix.site.name }}" \
            "build"

      - name: Generate GitHub App token for ${{ matrix.site.name }}
        if: ${{ !matrix.site.self }}
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.DOC_APP_ID }}
          private-key: ${{ secrets.DOC_APP_PRIVATE_KEY }}
          owner: fchastanet
          repositories: ${{ matrix.site.name }}

      - name: Deploy ${{ matrix.site.name }} to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ matrix.site.self && secrets.GITHUB_TOKEN || steps.app-token.outputs.token }}
          external_repository: ${{ !matrix.site.self && matrix.site.repo || '' }}
          publish_dir: build/${{ matrix.site.name }}/public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy ${{ matrix.site.name }} documentation'

      - name: Deployment summary
        if: success()
        run: |
          page_count=$(find "build/${{ matrix.site.name }}/public" -name '*.html' | wc -l)
          size=$(du -sh "build/${{ matrix.site.name }}/public" | cut -f1)
          (
            echo "### âœ… ${{ matrix.site.name }} deployed successfully"
            echo ""
            echo "ðŸ”— **URL:** ${{ matrix.site.baseURL }}/"
            echo "ðŸ“¦ **Pages:** $page_count"
            echo "ðŸ“„ **Size:** $size"
          ) >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf "build/${{ matrix.site.name }}"
          echo "âœ… Build artifacts cleaned up for ${{ matrix.site.name }}"
