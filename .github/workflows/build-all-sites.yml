---
name: Build All Documentation Sites

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-docs-rebuild]
  push:
    branches: [master]
    paths:
      - 'content/**'
      - 'shared/**'
      - 'configs/**'
      - '.github/workflows/build-all-sites.yml'

concurrency:
  group: build-all-sites
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - name: my-documents
            repo: fchastanet/my-documents
            repoRoot: orchestrator
            baseURL: 'https://fchastanet.github.io/my-documents'
            self: true
          - name: bash-compiler
            repo: fchastanet/bash-compiler
            repoRoot: sites/bash-compiler
            baseURL: 'https://fchastanet.github.io/bash-compiler'
            self: false
          - name: bash-tools
            repo: fchastanet/bash-tools
            repoRoot: sites/bash-tools
            baseURL: 'https://fchastanet.github.io/bash-tools'
            self: false
          - name: bash-tools-framework
            repo: fchastanet/bash-tools-framework
            rpoRoot: sites/bash-tools-framework
            baseURL: 'https://fchastanet.github.io/bash-tools-framework'
            self: false
          - name: bash-dev-env
            repo: fchastanet/bash-dev-env
            repoRoot: sites/bash-dev-env
            baseURL: 'https://fchastanet.github.io/bash-dev-env'
            self: false

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout my-documents (orchestrator)
        uses: actions/checkout@v6
        with:
          repository: fchastanet/my-documents
          path: orchestrator
          fetch-depth: 0

      - name: Checkout ${{ matrix.site.name }} content
        if: ${{ !matrix.site.self }}
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.site.repo }}
          path: sites/${{ matrix.site.name }}
          ref: master
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.155.3'
          extended: true

      - name: Install Dart Sass
        run: sudo snap install dart-sass

      - name: Install Node.js dependencies
        run: |
          npm ci

      - name: Install yq for YAML merging
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Prepare build for ${{ matrix.site.name }}
        run: |
          bash orchestrator/.github/scripts/build-site.sh \
            "${{ matrix.site.repoRoot }}" \
            "${{ matrix.site.name }}" \
            "build"

      - name: Generate GitHub App token for ${{ matrix.site.name }}
        if: ${{ !matrix.site.self }}
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.DOC_APP_ID }}
          private-key: ${{ secrets.DOC_APP_PRIVATE_KEY }}
          owner: fchastanet
          repositories: ${{ matrix.site.name }}

      - name: Deploy ${{ matrix.site.name }} to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ matrix.site.self && secrets.GITHUB_TOKEN || steps.app-token.outputs.token }}
          external_repository: ${{ !matrix.site.self && matrix.site.repo || '' }}
          publish_dir: ${{ env.BUILD_DIR }}/public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy ${{ matrix.site.name }} documentation'

      - name: Deployment summary
        run: |
          echo "### âœ… ${{ matrix.site.name }} deployed successfully" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ”— **URL:** ${{ matrix.site.baseURL }}/" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ“¦ **Pages:** $(find "${{ env.BUILD_DIR }}/public" -name '*.html' | wc -l)" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ“„ **Size:** $(du -sh "${{ env.BUILD_DIR }}/public" | cut -f1)" >> "$GITHUB_STEP_SUMMARY"
