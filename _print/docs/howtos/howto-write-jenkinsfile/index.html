<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://fchastanet.github.io/my-documents/docs/howtos/howto-write-jenkinsfile/><link rel=alternate type=application/rss+xml href=https://fchastanet.github.io/my-documents/docs/howtos/howto-write-jenkinsfile/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/my-documents/favicons/favicon.ico><link rel=apple-touch-icon href=/my-documents/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/my-documents/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/my-documents/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/my-documents/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/my-documents/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/my-documents/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/my-documents/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/my-documents/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/my-documents/favicons/android-192x192.png sizes=192x192><title>How to Write Jenkinsfiles | My Documents</title><meta name=description content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><meta property="og:url" content="https://fchastanet.github.io/my-documents/docs/howtos/howto-write-jenkinsfile/"><meta property="og:site_name" content="My Documents"><meta property="og:title" content="How to Write Jenkinsfiles"><meta property="og:description" content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="How to Write Jenkinsfiles"><meta itemprop=description content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><meta itemprop=wordCount content="67"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Write Jenkinsfiles"><meta name=twitter:description content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><link rel=preload href=/my-documents/scss/main.min.9e50c00facbebb58d8217b505ef77562d03cd9d47700a424a4a96bcc2c824633.css as=style integrity="sha256-nlDAD6y+u1jYIXtQXvd1YtA82dR3AKQkpKlrzCyCRjM=" crossorigin=anonymous><link href=/my-documents/scss/main.min.9e50c00facbebb58d8217b505ef77562d03cd9d47700a424a4a96bcc2c824633.css rel=stylesheet integrity="sha256-nlDAD6y+u1jYIXtQXvd1YtA82dR3AKQkpKlrzCyCRjM=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><meta name=description content="Technical documentation on Bash scripting, Docker, Jenkins, and development best practices"><meta name=keywords content="bash,best practices,learn,docker,jenkins,documentation"><meta name=robots content="index, follow"><meta name=author content="fchastanet"><script type=application/ld+json>{"@context":"https://schema.org","@type":"TechArticle","headline":"\u0022How to Write Jenkinsfiles\u0022","description":"\u0022Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles\u0022","author":{"@type":"Person","name":"\u0022fchastanet\u0022"},"publisher":{"@type":"Organization","name":"\u0022My Documents\u0022","url":"\u0022https:\/\/fchastanet.github.io\/my-documents\/\u0022"},"mainEntityOfPage":{"@type":"WebPage","@id":"\u0022https:\/\/fchastanet.github.io\/my-documents\/docs\/howtos\/howto-write-jenkinsfile\/\u0022"}}</script><meta property="og:title" content="How to Write Jenkinsfiles"><meta property="og:description" content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><meta property="og:url" content="https://fchastanet.github.io/my-documents/docs/howtos/howto-write-jenkinsfile/"><meta property="og:type" content="article"><meta property="og:site_name" content="My Documents"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="How to Write Jenkinsfiles"><meta name=twitter:description content="Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles"><link rel=canonical href=https://fchastanet.github.io/my-documents/docs/howtos/howto-write-jenkinsfile/></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll"><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/my-documents/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>My Documents</span></a><div class="td-navbar__main td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://github.com/fchastanet/my-documents target=_blank rel=noopener><span>GitHub</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://fchastanet.github.io/bash-tools-framework/ target=_blank rel=noopener><span>Bash Tools Framework</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://fchastanet.github.io/bash-tools/ target=_blank rel=noopener><span>Bash Tools</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://fchastanet.github.io/bash-dev-env/ target=_blank rel=noopener><span>Bash Dev Env</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://fchastanet.github.io/bash-compiler/ target=_blank rel=noopener><span>Bash Compiler</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="td-navbar__search d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search name=q class="td-search__input form-control" placeholder='Search this site…' aria-label='Search this site…' autocomplete=off data-offline-search-index-json-src=/my-documents/offline-search-index.01656e0e4f2430e2a37948525bf31617.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/my-documents/docs/howtos/howto-write-jenkinsfile/>Return to the regular view of this page</a>.</p></div><h1 class=title>How to Write Jenkinsfiles</h1><div class=lead>Comprehensive guide to writing Jenkins pipelines and Jenkinsfiles</div><ul><li>1: <a href=#pg-6971fa357af9d063f9640ffefd5beb05>How Jenkins Works</a></li><li>2: <a href=#pg-9869243d0d83c4e5b661966a7578774f>Jenkins Pipelines</a></li><li>3: <a href=#pg-8eb985311f27db5ec418f1717f4e0622>Jenkins Library</a></li><li>4: <a href=#pg-7468762d46626d9a543656cc02eabce8>Jenkins Best Practices</a></li><li>5: <a href=#pg-0f486b9cd450314fe64a457617932115>Annotated Jenkinsfiles - Part 1</a></li><li>6: <a href=#pg-4fc294def0f6cdaa02082959a217ca86>Annotated Jenkinsfiles - Part 2</a></li><li>7: <a href=#pg-ecd6072e7af2bd4a197a1087baeb6c77>Annotated Jenkinsfiles - Part 3</a></li><li>8: <a href=#pg-55c3c60a9f370d11db633ac258e1ebdc>Annotated Jenkinsfiles - Part 4</a></li><li>9: <a href=#pg-e4ae12237c39b5f0feb5a0e7e96b8e95>Annotated Jenkinsfiles - Part 5</a></li><li>10: <a href=#pg-495ca42bdd947744d65cf04377598dfb>Jenkins Recipes and Tips</a></li></ul><div class=content><p>This section provides comprehensive guides for writing Jenkinsfiles and working with Jenkins
pipelines.</p><div class="pageinfo pageinfo-primary"><p>This is a complete guide covering Jenkins architecture, pipeline syntax, shared libraries, best
practices, and annotated examples.</p></div><h2 id=1-what-youll-learn>1. What You&rsquo;ll Learn</h2><ul><li>How Jenkins works and its architecture</li><li>Declarative and scripted pipeline syntax</li><li>Creating and using Jenkins shared libraries</li><li>Jenkins best practices and configuration</li><li>Real-world Jenkinsfile examples with detailed annotations</li><li>Common recipes and troubleshooting tips</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6971fa357af9d063f9640ffefd5beb05>1 - How Jenkins Works</h1><div class=lead>Understanding Jenkins architecture and concepts</div><ul><li><a href=#1-jenkins-master-slave-architecture>1. Jenkins Master Slave Architecture</a><ul><li><a href=#11-jenkins-controllerjenkins-master-node>1.1. Jenkins controller/Jenkins master node</a></li><li><a href=#12-nodes>1.2. Nodes</a></li><li><a href=#13-agents>1.3. Agents</a></li><li><a href=#14-executors>1.4. Executors</a></li><li><a href=#15-jobs>1.5. Jobs</a></li></ul></li><li><a href=#2-jenkins-dynamic-node>2. Jenkins dynamic node</a></li></ul><p>Source: <a href=https://www.jenkins.io/doc/book/managing/nodes/>https://www.jenkins.io/doc/book/managing/nodes/</a></p><p>Source glossary: <a href=https://www.jenkins.io/doc/book/glossary/>https://www.jenkins.io/doc/book/glossary/</a></p><h2 id=1-jenkins-master-slave-architecture>1. Jenkins Master Slave Architecture</h2><p><img src="https://i0.wp.com/digitalvarys.com/wp-content/uploads/2019/05/image-4.png?resize=920%2C581" alt="Jenkins Master Slave Architecture"></p><p>The Jenkins <strong>controller</strong> is the <strong>master node</strong> which is able to launch <strong>jobs</strong> on different <strong>nodes</strong> (machines)
directed by an <strong>Agent</strong>. The Agent can the use one or several <strong>executors</strong> to execute the job(s) depending on
configuration.</p><p>Jenkins is using Master/Slave architecture with the following components:</p><h3 id=11-jenkins-controllerjenkins-master-node>1.1. Jenkins controller/Jenkins master node</h3><blockquote><p>The central, coordinating process which stores configuration, loads plugins, and renders the various user interfaces
for Jenkins.</p></blockquote><p>The Jenkins controller is the Jenkins service itself and is where Jenkins is installed. It is a webserver that also acts
as a &ldquo;brain&rdquo; for deciding how, when and where to run tasks. Management tasks (configuration, authorization, and
authentication) are executed on the controller, which serves HTTP requests. Files written when a Pipeline executes are
written to the filesystem on the controller unless they are off-loaded to an artifact repository such as Nexus or
Artifactory.</p><h3 id=12-nodes>1.2. Nodes</h3><blockquote><p>A machine which is part of the Jenkins environment and capable of executing
<a href=https://www.jenkins.io/doc/book/glossary/#pipeline>Pipelines</a> or
<a href=https://www.jenkins.io/doc/book/glossary/#job>jobs</a>. Both the
<a href=https://www.jenkins.io/doc/book/glossary/#controller>Controller</a> and
<a href=https://www.jenkins.io/doc/book/glossary/#agent>Agents</a> are considered to be Nodes.</p></blockquote><p>Nodes are the &ldquo;<strong>machines</strong>&rdquo; on which build agents run. Jenkins monitors each attached node for disk space, free temp
space, free swap, clock time/sync and response time. A node is taken offline if any of these values go outside the
configured threshold.</p><p>The Jenkins controller itself runs on a special <em>built-in node</em>. It is possible to run agents and executors on this
built-in node although this can degrade performance, reduce scalability of the Jenkins instance, and create serious
security problems and is strongly discouraged, especially for production environments.</p><h3 id=13-agents>1.3. Agents</h3><blockquote><p>An agent is typically a machine, or container, which connects to a Jenkins controller and executes tasks when directed
by the controller.</p></blockquote><p>Agents manage the task execution on behalf of the Jenkins controller by using executors. An agent is actually a small
(170KB single jar) Java client process that connects to a Jenkins controller and is assumed to be unreliable. An agent
can use any operating system that supports Java. Tools required for builds and tests are installed on the node where the
agent runs; they can be installed directly or in a container (Docker or Kubernetes). Each agent is effectively a process
with its own PID (Process Identifier) on the host machine.</p><blockquote><p>In practice, nodes and agents are essentially the same but it is good to remember that they are conceptually distinct.</p></blockquote><h3 id=14-executors>1.4. Executors</h3><blockquote><p>A slot for execution of work defined by a <a href=https://www.jenkins.io/doc/book/glossary/#pipeline>Pipeline</a> or
<a href=https://www.jenkins.io/doc/book/glossary/#job>job</a> on a <a href=https://www.jenkins.io/doc/book/glossary/#node>Node</a>. A
Node may have zero or more Executors configured which corresponds to how many concurrent Jobs or Pipelines are able to
execute on that Node.</p></blockquote><p>An executor is a slot for execution of tasks; effectively, it is a thread in the agent. The number of executors on a
node defines the number of concurrent tasks that can be executed on that node at one time. In other words, this
determines the number of concurrent Pipeline stages that can execute on that node at one time.</p><p>The proper number of executors per build node must be determined based on the resources available on the node and the
resources required for the workload. When determining how many executors to run on a node, consider CPU and memory
requirements as well as the amount of I/O and network activity:</p><ul><li>One executor per node is the safest configuration.</li><li>One executor per CPU core may work well if the tasks being run are small.</li><li>Monitor I/O performance, CPU load, memory usage, and I/O throughput carefully when running multiple executors on a
node.</li></ul><h3 id=15-jobs>1.5. Jobs</h3><blockquote><p>A user-configured description of work which Jenkins should perform, such as building a piece of software, etc.</p></blockquote><h2 id=2-jenkins-dynamic-node>2. Jenkins dynamic node</h2><p>Jenkins has static slave nodes and can trigger the generation of dynamic slave nodes</p><p><img src=images/JenkinsMasterSlave.png alt="Jenkins Master/slave architecture"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9869243d0d83c4e5b661966a7578774f>2 - Jenkins Pipelines</h1><div class=lead>Declarative and scripted pipeline syntax</div><ul><li><a href=#1-what-is-a-pipeline->1. What is a pipeline ?</a></li><li><a href=#2-pipeline-creation-via-ui>2. Pipeline creation via UI</a></li><li><a href=#3-groovy>3. Groovy</a></li><li><a href=#4-difference-between-scripted-pipeline-freestyle-and-declarative-pipeline-syntax>4. Difference between scripted pipeline (freestyle) and declarative pipeline syntax</a></li><li><a href=#5-declarative-pipeline-example>5. Declarative pipeline example</a></li><li><a href=#6-scripted-pipeline-example>6. Scripted pipeline example</a></li><li><a href=#7-why-pipeline>7. Why Pipeline?</a></li></ul><h2 id=1-what-is-a-pipeline->1. What is a pipeline ?</h2><p><a href=https://www.jenkins.io/doc/book/pipeline/>https://www.jenkins.io/doc/book/pipeline/</a></p><blockquote><p>Jenkins Pipeline (or simply &ldquo;Pipeline&rdquo; with a capital &ldquo;P&rdquo;) is a suite of plugins which supports implementing and
integrating <em>continuous delivery pipelines</em> into Jenkins.</p><p>A <em>continuous delivery (CD) pipeline</em> is an automated expression of your process for getting software from version
control right through to your users and customers. Every change to your software (committed in source control) goes
through a complex process on its way to being released. This process involves building the software in a reliable and
repeatable manner, as well as progressing the built software (called a &ldquo;build&rdquo;) through multiple stages of testing and
deployment.</p><p>Pipeline provides an extensible set of tools for modeling simple-to-complex delivery pipelines &ldquo;as code&rdquo; via the
<a href=https://www.jenkins.io/doc/book/pipeline/syntax>Pipeline domain-specific language (DSL) syntax</a>.
<a href=https://www.jenkins.io/doc/book/pipeline/#_footnotedef_1 title="View footnote.">View footnote 1</a></p><p>The definition of a Jenkins Pipeline is written into a text file (called a
<a href=https://www.jenkins.io/doc/book/pipeline/jenkinsfile><code>Jenkinsfile</code></a>) which in turn can be committed to a project’s
source control repository.
<a href=https://www.jenkins.io/doc/book/pipeline/#_footnotedef_2 title="View footnote.">View footnote 2</a> This is the foundation of
&ldquo;Pipeline-as-code&rdquo;; treating the CD pipeline a part of the application to be versioned and reviewed like any other
code.</p></blockquote><h2 id=2-pipeline-creation-via-ui>2. Pipeline creation via UI</h2><p>it&rsquo;s not recommended but it&rsquo;s possible to create a pipeline via the UI.</p><p>There are several drawbacks:</p><ul><li>no code revision</li><li>difficult to read, understand</li></ul><h2 id=3-groovy>3. Groovy</h2><p>Scripted and declarative pipelines are using groovy language.</p><p>Checkout <a href=https://www.guru99.com/groovy-tutorial.html>https://www.guru99.com/groovy-tutorial.html</a> to have a quick
overview of this derived language check <a href=https://en.wikipedia.org/wiki/Apache_Groovy>Wikipedia</a></p><h2 id=4-difference-between-scripted-pipeline-freestyle-and-declarative-pipeline-syntax>4. Difference between scripted pipeline (freestyle) and declarative pipeline syntax</h2><p>What are the main differences ? Here are some of the most important things you should know:</p><ul><li>Basically, declarative and scripted pipelines differ in terms of the programmatic approach. One uses a declarative
programming model and the second uses an imperative programming mode.</li><li>Declarative pipelines break down stages into multiple steps, while in scripted pipelines there is no need for this.
Example below</li></ul><p>Declarative and Scripted Pipelines are constructed fundamentally differently. <strong>Declarative Pipeline is a more recent
feature of Jenkins Pipeline</strong> which:</p><ul><li>provides richer syntactical features over Scripted Pipeline syntax, and</li><li>is designed to make writing and reading Pipeline code easier.</li><li>By default automatically checkout stage</li></ul><p>Many of the individual syntactical components (or &ldquo;steps&rdquo;) written into a <code>Jenkinsfile</code>, however, are common to both
Declarative and Scripted Pipeline. Read more about how these two types of syntax differ in
<a href=https://www.jenkins.io/doc/book/pipeline/#pipeline-concepts>Pipeline concepts</a> and
<a href=https://www.jenkins.io/doc/book/pipeline/#pipeline-syntax-overview>Pipeline syntax overview</a>.</p><h2 id=5-declarative-pipeline-example>5. Declarative pipeline example</h2><p><a href=https://www.jenkins.io/doc/book/pipeline/syntax/>Pipeline syntax documentation</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span> <span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// executed on an executor with the label &#39;some-label&#39;
</span></span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// or &#39;docker&#39;, the label normally specifies:
</span></span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// - the size of the machine to use
</span></span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>//   (eg.: Docker-C5XLarge used for build that needs a powerful machine)
</span></span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>// - the features you want in your machine
</span></span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>//   (eg.: docker-base-ubuntu an image with docker command available)
</span></span></span><span style=display:flex><span>     <span style=color:#000>label</span> <span style=color:#4e9a06>&#34;some-label&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>     <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#8f5902;font-style:italic>// variable assignment and Complex global
</span></span></span><span style=display:flex><span>         <span style=color:#8f5902;font-style:italic>// variables (with properties or methods)
</span></span></span><span style=display:flex><span>         <span style=color:#8f5902;font-style:italic>// can only be done in a script block
</span></span></span><span style=display:flex><span>         <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>           <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>image</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;ubuntu&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${foo.imageName()}&#34;</span>
</span></span><span style=display:flex><span>           <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;foo: ${foo.imageName()}&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>       <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>steps</span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;bar: ${env.bar}&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;foo: ${foo.imageName()}&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=6-scripted-pipeline-example>6. Scripted pipeline example</h2><p>Scripted pipelines permit a developer to inject code, while the declarative Jenkins pipeline doesn’t. <strong>should be
avoided actually, try to use jenkins library instead</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>git</span> <span style=color:#f57900>url:</span> <span style=color:#4e9a06>&#39;https://github.com/jfrogdev/project-examples.git&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Get Artifactory server instance, defined in the Artifactory Plugin
</span></span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// administration page.
</span></span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>server</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Artifactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>server</span> <span style=color:#4e9a06>&#34;SERVER_ID&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Read the upload spec and upload files to Artifactory.
</span></span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>downloadSpec</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>       <span style=color:#4e9a06>&#39;&#39;&#39;{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       &#34;files&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>         {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;pattern&#34;: &#34;libs-snapshot-local/*.zip&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;target&#34;: &#34;dependencies/&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;props&#34;: &#34;p1=v1;p2=v2&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>         }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   }&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buildInfo1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>download</span> <span style=color:#f57900>spec:</span> <span style=color:#000>downloadSpec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Read the upload spec which was downloaded from github.
</span></span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>uploadSpec</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>     <span style=color:#4e9a06>&#39;&#39;&#39;{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>     &#34;files&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;pattern&#34;: &#34;resources/Kermit.*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;target&#34;: &#34;libs-snapshot-local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;props&#34;: &#34;p1=v1;p2=v2&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;pattern&#34;: &#34;resources/Frogger.*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;target&#34;: &#34;libs-snapshot-local&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>       }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   }&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Upload to Artifactory.
</span></span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buildInfo2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>upload</span> <span style=color:#f57900>spec:</span> <span style=color:#000>uploadSpec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Merge the upload and download build-info objects.
</span></span></span><span style=display:flex><span>  <span style=color:#000>buildInfo1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span> <span style=color:#000>buildInfo2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Publish the build to Artifactory
</span></span></span><span style=display:flex><span>  <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishBuildInfo</span> <span style=color:#000>buildInfo1</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=7-why-pipeline>7. Why Pipeline?</h2><p>Jenkins is, fundamentally, an automation engine which supports a number of automation patterns. Pipeline adds a powerful
set of automation tools onto Jenkins, supporting use cases that span from simple continuous integration to comprehensive
CD pipelines. By modeling a series of related tasks, users can take advantage of the many features of Pipeline:</p><ul><li><strong>Code</strong>: Pipelines are implemented in code and typically checked into source control, giving teams the ability to
edit, review, and iterate upon their delivery pipeline.</li><li><strong>Durable</strong>: Pipelines can survive both planned and unplanned restarts of the Jenkins controller.</li><li><strong>Pausable</strong>: Pipelines can optionally stop and wait for human input or approval before continuing the Pipeline run.</li><li><strong>Versatile</strong>: Pipelines support complex real-world CD requirements, including the ability to fork/join, loop, and
perform work in parallel.</li><li><strong>Extensible</strong>: The Pipeline plugin supports custom extensions to its DSL
<a href=https://www.jenkins.io/doc/book/pipeline/#_footnotedef_1>see jenkins doc</a> and multiple options for integration with
other plugins.</li></ul><p>While Jenkins has always allowed rudimentary forms of chaining Freestyle Jobs together to perform sequential tasks,
<a href=https://www.jenkins.io/doc/book/pipeline/#_footnotedef_4>see jenkins doc</a> Pipeline makes this concept a first-class
citizen in Jenkins.</p><p>More information on <a href=https://www.jenkins.io/doc/book/pipeline/>Official jenkins documentation - Pipeline</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8eb985311f27db5ec418f1717f4e0622>3 - Jenkins Library</h1><div class=lead>Creating and using Jenkins shared libraries</div><ul><li><a href=#1-what-is-a-jenkins-shared-library->1. What is a jenkins shared library ?</a></li><li><a href=#2-loading-libraries-dynamically>2. Loading libraries dynamically</a></li><li><a href=#3-jenkins-library-directory-structure>3. jenkins library directory structure</a></li><li><a href=#4-jenkins-library>4. Jenkins library</a></li><li><a href=#5-jenkins-library-structure>5. Jenkins library structure</a></li><li><a href=#6-external-resource-usage>6. external resource usage</a></li></ul><h2 id=1-what-is-a-jenkins-shared-library->1. What is a jenkins shared library ?</h2><blockquote><p>As Pipeline is adopted for more and more projects in an organization, common patterns are likely to emerge. Oftentimes
it is useful to share parts of Pipelines between various projects to reduce redundancies and keep code &ldquo;DRY&rdquo;</p></blockquote><p>for more information check <a href=https://www.jenkins.io/doc/book/pipeline/shared-libraries/>pipeline shared libraries</a></p><h2 id=2-loading-libraries-dynamically>2. Loading libraries dynamically</h2><p>As of version 2.7 of the <em>Pipeline: Shared Groovy Libraries</em> plugin, there is a new option for loading (non-implicit)
libraries in a script: a <code>library</code> step that loads a library <em>dynamically</em>, at any time during the build.</p><p>If you are only interested in using global variables/functions (from the <code>vars/</code> directory), the syntax is quite simple:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>library</span> <span style=color:#4e9a06>&#39;my-shared-library&#39;</span>
</span></span></code></pre></div><p>Thereafter, any global variables from that library will be accessible to the script.</p><h2 id=3-jenkins-library-directory-structure>3. jenkins library directory structure</h2><p>The directory structure of a Shared Library repository is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-text data-lang=text><span style=display:flex;background-color:#dfdfdf><span>(root)
</span></span><span style=display:flex><span>+- src        # Groovy source files
</span></span><span style=display:flex><span>|   +- org
</span></span><span style=display:flex><span>|       +- foo
</span></span><span style=display:flex><span>|           +- Bar.groovy  # for org.foo.Bar class
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>+- vars       # The vars directory hosts script
</span></span><span style=display:flex><span>              # files that are exposed as a variable in Pipelines
</span></span><span style=display:flex><span>|   +- foo.groovy          # for global &#39;foo&#39; variable
</span></span><span style=display:flex><span>|   +- foo.txt             # help for &#39;foo&#39; variable
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>+- resources  # resource files (external libraries only)
</span></span><span style=display:flex><span>|   +- org
</span></span><span style=display:flex><span>|      +- foo
</span></span><span style=display:flex><span>|         +- bar.json      # static helper data for org.foo.Bar
</span></span></code></pre></div><h2 id=4-jenkins-library>4. Jenkins library</h2><p>remember that jenkins library code is executed on master node</p><p>if you want to execute code on the node, you need to use jenkinsExecutor</p><p>usage of jenkins executor</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>String</span> <span style=color:#000>credentialsId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;babee6c1-14fe-4d90-9da0-ffa7068c69af&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>library</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>identifier:</span> <span style=color:#4e9a06>&#39;jenkins_library@v1.0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>retriever:</span> <span style=color:#000>modernSCM</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>        <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;GitSCMSource&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>remote:</span> <span style=color:#4e9a06>&#39;git@github.com:fchastanet/jenkins-library.git&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>credentialsId:</span> <span style=color:#000>credentialsId</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// this is the jenkinsExecutor instance
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>docker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Then in the library, it is used like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>jenkinsExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sh</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>script:</span> <span style=color:#4e9a06>&#34;docker pull ${cacheTag}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>returnStatus:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=5-jenkins-library-structure>5. Jenkins library structure</h2><p>I remarked that a lot of code was duplicated between all my Jenkinsfiles so I created this library
<a href=https://github.com/fchastanet/jenkins-library>https://github.com/fchastanet/jenkins-library</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-text data-lang=text><span style=display:flex;background-color:#dfdfdf><span>(root)
</span></span><span style=display:flex><span>+- doc    # markdown files automatically generated
</span></span><span style=display:flex><span>          # from groovy files by generateDoc.sh
</span></span><span style=display:flex><span>+- src    # Groovy source files
</span></span><span style=display:flex><span>|   +- fchastanet
</span></span><span style=display:flex><span>|       +- Cloudflare.groovy     # zonePurge
</span></span><span style=display:flex><span>|       +- Docker.groovy         # getTagCompatibleFromBranch
</span></span><span style=display:flex><span>                                 # pullBuildPushImage, ...
</span></span><span style=display:flex><span>|       +- Git.groovy            # getRepoURL, getCommitSha,
</span></span><span style=display:flex><span>                                 # getLastPusherEmail,
</span></span><span style=display:flex><span>                                 # updateConditionalGithubCommitStatus
</span></span><span style=display:flex><span>|       +- Kubernetes.groovy     # deployHelmChart, ...
</span></span><span style=display:flex><span>|       +- Lint.groovy           # dockerLint,
</span></span><span style=display:flex><span>                                 # transform lighthouse report
</span></span><span style=display:flex><span>                                 # to Warnings NG issues format
</span></span><span style=display:flex><span>|       +- Mail.groovy           # sendTeamsNotification,
</span></span><span style=display:flex><span>                                 # sendConditionalEmail, ...
</span></span><span style=display:flex><span>|       +- Utils.groovy          # deepMerge, isCollectionOrArray,
</span></span><span style=display:flex><span>                                 # deleteDirAsRoot,
</span></span><span style=display:flex><span>                                 # initAws (could be moved to Aws class)
</span></span><span style=display:flex><span>+- vars   # The vars directory hosts script files that
</span></span><span style=display:flex><span>          # are exposed as a variable in Pipelines
</span></span><span style=display:flex><span>|   +- dockerPullBuildPush.groovy #
</span></span><span style=display:flex><span>|   +- whenOrSkip.groovy          #
</span></span></code></pre></div><h2 id=6-external-resource-usage>6. external resource usage</h2><p>If you need you check out how I used this repository <a href=https://github.com/fchastanet/jenkins-library-resources>https://github.com/fchastanet/jenkins-library-resources</a> in
jenkins_library (Linter) that hosts some resources to parse result files.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7468762d46626d9a543656cc02eabce8>4 - Jenkins Best Practices</h1><div class=lead>Best practices for Jenkins configuration</div><ul><li><a href=#1-pipeline-best-practices>1. Pipeline best practices</a></li><li><a href=#2-shared-library-best-practices>2. Shared library best practices</a></li></ul><h2 id=1-pipeline-best-practices>1. Pipeline best practices</h2><p><a href=https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/#general>Official Jenkins pipeline best practices</a></p><p>Summary:</p><ul><li>Make sure to use Groovy code in Pipelines as glue</li><li>Externalize shell scripts from Jenkins Pipeline<ul><li>for better jenkinsfile readability</li><li>in order to test the scripts isolated from jenkins</li></ul></li><li>Avoid complex Groovy code in Pipelines<ul><li>Groovy code <strong>always</strong> executes on controller which means using controller resources(memory and CPU)<ul><li>it is not the case for shell scripts</li></ul></li><li>eg1: prefer using <strong>jq</strong> inside shell script instead of groovy JsonSlurper</li><li>eg2: prefer calling <strong>curl</strong> instead of groovy http request</li></ul></li><li>Reducing repetition of similar Pipeline steps (eg: one sh step instead of severals)<ul><li>group similar steps together to avoid step creation/destruction overhead</li></ul></li><li>Avoiding calls to Jenkins.getInstance</li></ul><h2 id=2-shared-library-best-practices>2. Shared library best practices</h2><p><a href=https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/#using-shared-libraries>Official Jenkins shared libraries best practices</a></p><p>Summary:</p><ul><li>Do not override built-in Pipeline steps</li><li>Avoiding large global variable declaration files</li><li>Avoiding very large shared libraries</li></ul><p>And:</p><ul><li>import jenkins library using a tag<ul><li>like in docker build, npm package with package-lock.json or python pip lock, it&rsquo;s advised to target a given version
of the library<ul><li>because some changes could break</li></ul></li></ul></li><li>The missing part: we miss on this library unit tests<ul><li>but each pipeline is a kind of integration test</li></ul></li><li>Because a pipeline can be
<a href=https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/#avoiding-notserializableexception>resumed</a>, your
library&rsquo;s classes should implement Serializable class and the following attribute has to be provided:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0f486b9cd450314fe64a457617932115>5 - Annotated Jenkinsfiles - Part 1</h1><div class=lead>Detailed Jenkinsfile examples with annotations</div><p><a href=https://www.jenkins.io/doc/book/pipeline/#pipeline-example>Pipeline example</a></p><h2 id=1-simple-one>1. Simple one</h2><p>This build is used to generate docker images used to build production code and launch phpunit tests. This pipeline is
parameterized in the Jenkins UI directly with the parameters:</p><ul><li>branch (git branch to use)</li><li>environment(select with 3 options: build, phpunit or all)<ul><li>it would have been better to use simply 2 checkboxes phpunit/build</li></ul></li><li>project_branch</li></ul><p>Here the source code with inline comments:</p><p><strong>Annotated jenkinsfile</strong> Expand source</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>// This method allows to convert the branch name to a docker image tag.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// This method is generally used by most of my jenkins pipelines, it&#39;s why it has been added to https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Docker.groovy#L31
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTagCompatibleFromBranch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>branchName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>tag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>branchName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#000>tag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^origin/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;_&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// we declare here some variables that will be used in next stages
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>deploymentBranchTagCompatible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// the pipeline is executed on a machine with docker daemon
</span></span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// available
</span></span></span><span style=display:flex><span>            <span style=color:#000>label</span> <span style=color:#4e9a06>&#39;docker-ubuntu&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;checkout&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// this command is actually not necessary because checkout is
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// done automatically when using declarative pipeline
</span></span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;echo &#34;pulling ... ${GIT_BRANCH#origin/}&#34;&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>checkout</span> <span style=color:#000>scm</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// this particular build needs to access to some private github
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// repositories, so here we are copying the ssh key
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// it would be better to use new way of injecting ssh key
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// inside docker using sshagent
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// check https://stackoverflow.com/a/66897280
</span></span></span><span style=display:flex><span>                <span style=color:#000>withCredentials</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>sshUserPrivateKey</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>                      <span style=color:#f57900>credentialsId:</span> <span style=color:#4e9a06>&#39;855aad9f-1b1b-494c-aa7f-4de881c7f659&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#f57900>keyFileVariable:</span> <span style=color:#4e9a06>&#39;sshKeyFile&#39;</span>
</span></span><span style=display:flex><span>                   <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// best practice similar steps should be merged into one
</span></span></span><span style=display:flex><span>                    <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;rm -f ./phpunit/id_rsa&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;rm -f ./build/id_rsa&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// here we are escaping &#39;$&#39; so the variable will be
</span></span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// interpolated on the jenkins slave and not the jenkins
</span></span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// master node instead of escaping, we could have used
</span></span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// single quotes
</span></span></span><span style=display:flex><span>                    <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;cp \$sshKeyFile ./phpunit/id_rsa&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;cp \$sshKeyFile ./build/id_rsa&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// as actually scm is already done before executing the
</span></span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// first step, this call could have been done during
</span></span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// declaration of this variable
</span></span></span><span style=display:flex><span>                    <span style=color:#000>deploymentBranchTagCompatible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTagCompatibleFromBranch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;build Build env&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// the build can be launched with the parameter environment
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// defined in the configuration of the jenkins job, these
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// parameters could have been defined directly in the pipeline
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// see https://www.jenkins.io/doc/book/pipeline/syntax/#parameters
</span></span></span><span style=display:flex><span>                <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;phpunit&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// here we could have launched all this commands in the same sh
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// directive
</span></span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker build --build-arg BRANCH=${params.project_branch} -t build build&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// use a constant for dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com
</span></span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker tag build dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com/build:${deploymentBranchTagCompatible}&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker push dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com/build:${deploymentBranchTagCompatible}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;build PHPUnit env&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// it would have been cleaner to use
</span></span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// expression { return params.environment = &#34;phpunit&#34;}
</span></span></span><span style=display:flex><span>                <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;build&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker build --build-arg BRANCH=${params.project_branch} -t phpunit phpunit&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker tag phpunit dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com/phpunit:${deploymentBranchTagCompatible}&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker push dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com/phpunit:${deploymentBranchTagCompatible}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>without seeing the Dockerfile files, we can advise :</p><ul><li>to build these images in the same pipeline where build and phpunit are run<ul><li>the images are built at the same time so we are sure that we are using the right version</li></ul></li><li>apparently the docker build depend on the branch of the project, this should be avoided</li><li>ssh key is used in docker image, that could lead to a <strong>security issue</strong> as ssh key is still in the history of images
layers even if it has been removed in subsequent layers, check <a href=https://stackoverflow.com/a/66897280>https://stackoverflow.com/a/66897280</a> for information
on how to use ssh-agent instead</li><li>we could use a single Dockerfile with 2 stages:<ul><li>one stage to generate production image</li><li>one stage that inherits production stage, used to execute phpunit</li><li>it has the following advantages :<ul><li>reduce the total image size because of the reuse different docker image layers</li><li>only one Dockerfile to maintain</li></ul></li></ul></li></ul><h2 id=2-more-advanced-and-annotated-jenkinsfiles>2. More advanced and annotated Jenkinsfiles</h2><ul><li><a href=05-01-Annotated-Jenkinsfiles.md>php project with helm push</a></li><li><a href=05-02-Annotated-Jenkinsfiles.md>javascript project with docker build and S3 push</a></li><li><a href=05-03-Annotated-Jenkinsfiles.md>browser extension build and deployment</a></li><li><a href=05-04-Annotated-Jenkinsfiles.md>jenkins library - reusable pipeline generation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4fc294def0f6cdaa02082959a217ca86>6 - Annotated Jenkinsfiles - Part 2</h1><div class=lead>More annotated Jenkinsfile examples</div><h2 id=1-introduction>1. Introduction</h2><p>This example is missing the use of parameters, jenkins library in order to reuse common code</p><p>This example uses :</p><ul><li>post conditions
<a href=https://www.jenkins.io/doc/book/pipeline/syntax/#post>https://www.jenkins.io/doc/book/pipeline/syntax/#post</a></li><li>github plugin to set commit status indicating the result of the build</li><li>usage of <strong>several jenkins plugins</strong>, you can check here to get the full list installed on your server and even
<strong>generate code snippets</strong> by adding <strong>pipeline-syntax/</strong> to your jenkins server url</li></ul><p>But it misses:</p><ul><li>usage of <a href=https://www.jenkins.io/doc/book/pipeline/syntax/#parameters>inline parameters</a></li><li>usage of jenkins library to reuse common code<ul><li><a href=https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Git.groovy#L156>Git updateConditionalGithubCommitStatus</a></li><li><a href=https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Docker.groovy#L46>Docker pullBuildPushImage</a></li></ul></li></ul><p>check <a href=https://www.jenkins.io/doc/book/pipeline/syntax/>Pipeline syntax documentation</a></p><h2 id=2-annotated-jenkinsfile>2. Annotated Jenkinsfile</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>// Define variables for QA environment
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>registry_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;awsAccountId&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>registry_url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry_id</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.dkr.ecr.us-east-1.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>image_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;project&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>image_fqdn_master</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry_url</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>image_name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;:master&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>image_fqdn_current_branch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>image_fqdn_master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// this method is used by several of my pipelines and has been added
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// to jenkins_library &lt;https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Git.groovy#L156&gt;
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>publishStatusToGithub</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>    <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;GitHubCommitStatusSetter&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>reposSource:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ManuallyEnteredRepositorySource&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>url:</span> <span style=color:#4e9a06>&#34;https://github.com/fchastanet/project&#34;</span><span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>errorHandlers:</span> <span style=color:#ce5c00;font-weight:700>[[</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;ShallowAnyErrorHandler&#39;</span><span style=color:#ce5c00;font-weight:700>]],</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>statusResultSource:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>      <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;ConditionalStatusResultSource&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>results:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;AnyBuildResult&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>state:</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// bad practice: try to indicate in your node labels, which feature it
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// includes for example, here we need docker, label could have been
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// &#39;eks-nonprod-docker&#39;
</span></span></span><span style=display:flex><span>      <span style=color:#000>label</span> <span style=color:#4e9a06>&#39;eks-nonprod&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Checkout&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// checkout is not necessary as it is automatically done
</span></span></span><span style=display:flex><span>        <span style=color:#000>checkout</span> <span style=color:#000>scm</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// &#39;wrap&#39; allows to inject some useful variables like BUILD_USER,
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// BUILD_USER_FIRST_NAME
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// see https://www.jenkins.io/doc/pipeline/steps/build-user-vars-plugin/
</span></span></span><span style=display:flex><span>          <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>([</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;BuildUser&#39;</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#${currentBuild.number}_${BRANCH}_${BUILD_USER}_${DEPLOYMENT}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// params could have been defined inside the pipeline directly
</span></span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// instead of defining them in jenkins build configuration
</span></span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;staging&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${displayName}_${INSTANCE}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// next line allows to change the build name, check addHtmlBadge
</span></span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// plugin function for more advanced usage of this feature, you
</span></span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// check this jenkinsfile 05-02-Annotated-Jenkinsfiles.md
</span></span></span><span style=display:flex><span>            <span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>displayName</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Run tests&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// all these sh directives could have been merged into one
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// it is best to use a separated sh file that could take some parameters
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// as it is simpler to read and to eventually test separately
</span></span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;docker build -t project-test &#34;$PWD&#34;/docker/test&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;cp &#34;$PWD&#34;/app/config/parameters.yml.dist &#34;$PWD&#34;/app/config/parameters.yml&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// for better readability and if separated script is not possible, use
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// continuation line for better readability
</span></span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;docker run -i --rm -v &#34;$PWD&#34;:/var/www/html/ -w /var/www/html/ project-test  /bin/bash -c &#34;composer install -a &amp;&amp; ./bin/phpunit -c /var/www/html/app/phpunit.xml --coverage-html /var/www/html/var/logs/coverage/ --log-junit /var/www/html/var/logs/phpunit.xml  --coverage-clover /var/www/html/var/logs/clover_coverage.xml&#34;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// Run the steps in the post section regardless of the completion status
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// of the Pipeline’s or stage’s run.
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// see https://www.jenkins.io/doc/book/pipeline/syntax/#post
</span></span></span><span style=display:flex><span>      <span style=color:#000>post</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>always</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// report unit test reports (unit test should generate result using
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// using junit format)
</span></span></span><span style=display:flex><span>          <span style=color:#000>junit</span> <span style=color:#4e9a06>&#39;var/logs/phpunit.xml&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// generate coverage page from test results
</span></span></span><span style=display:flex><span>          <span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>            <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;CloverPublisher&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>cloverReportDir:</span> <span style=color:#4e9a06>&#39;var/logs/&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>cloverReportFileName:</span> <span style=color:#4e9a06>&#39;clover_coverage.xml&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// publish html page with the result of the coverage
</span></span></span><span style=display:flex><span>          <span style=color:#000>publishHTML</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>target:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>allowMissing:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>alwaysLinkToLastBuild:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>keepAll:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>reportDir:</span> <span style=color:#4e9a06>&#39;var/logs/coverage/&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>reportFiles:</span> <span style=color:#4e9a06>&#39;index.html&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>reportName:</span> <span style=color:#4e9a06>&#34;Coverage Report&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// this stage will be executed only if previous stage is successful
</span></span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Build image&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// this stage is executed only if these conditions returns true
</span></span></span><span style=display:flex><span>        <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;staging&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;origin/master&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// this code is used in most of the pipeline and has been centralized
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// in https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Git.groovy#L39
</span></span></span><span style=display:flex><span>          <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IMAGE_TAG</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_COMMIT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// Update variable for production environment
</span></span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;prod&#39;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>registry_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;awsDockerRegistryId&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>registry_url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry_id</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.dkr.ecr.eu-central-1.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>image_fqdn_master</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry_url</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>image_name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;:master&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#000>image_fqdn_current_branch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>registry_url</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>image_name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;:&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IMAGE_TAG</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// As jenkins slave machine can be constructed on demand,
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// it doesn&#39;t always contains all docker image cache
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// here to avoid building docker image from scratch, we are trying to
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// pull an existing version of the docker image on docker registry
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// and then build using this image as cache, so all layers not updated
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// in Dockerfile will not be built again (gain of time)
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// It is again a recurrent usage in most of the pipelines
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// so the next 8 lines could be replaced by the call to this method
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Docker
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// pullBuildPushImage https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Docker.groovy#L46
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Pull the master from repository (|| true avoids errors if the image
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// hasn&#39;t been pushed before)
</span></span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;docker pull ${image_fqdn_master} || true&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Build the image using pulled image as cache
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// instead of using concatenation, it is more readable to use variable interpolation
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Eg: &#34;docker build --cache-from ${image_fqdn_master} -t ...&#34;
</span></span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;docker build \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --cache-from &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>image_fqdn_master</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -t &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>image_name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -f &#34;$PWD/docker/prod/Dockerfile&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            .&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Deploy image (Staging)&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;staging&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// Actually we should always push the image in order to be able to
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// feed the docker cache for next builds
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// Again the method Docker pullBuildPushImage https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Docker.groovy#L46
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// solves this issue and could be used instead of the next 6 lines
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// and &#34;Push image (Prod)&#34; stage
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// If building master, we should push the image with the tag master
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// to benefit from docker cache
</span></span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;origin/master&#39;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Tag the image as master&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker tag ${image_name} ${image_fqdn_master}&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Push the image as master&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker push ${image_fqdn_master}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Tag the image&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker tag ${image_name} ${image_fqdn_current_branch}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Push the image&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker push ${image_fqdn_current_branch}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// use variable interpolation instead of concatenation
</span></span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Deploy on cluster&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          helm3 upgrade project-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; -i \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --namespace project-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --create-namespace \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --cleanup-on-fail \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --atomic \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -f helm/values_files/values-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.yaml \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --set deployment.php_container.image.pullPolicy=Always \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            --set image.tag=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IMAGE_TAG</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            ./helm&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Push image (Prod)&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPLOYMENT</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;origin/master&#39;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// The method Docker pullBuildPushImage https://github.com/fchastanet/jenkins-library/blob/master/src/fchastanet/Docker.groovy#L46
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// provides a generic way of managing the pull, build, push of the docker
</span></span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// images, by managing also a common way of tagging docker images
</span></span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Tag the image as master&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker tag ${image_name} ${image_fqdn_current_branch}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#f57900>label:</span><span style=color:#4e9a06>&#34;Push the image as master&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>script:</span><span style=color:#4e9a06>&#34;docker push ${image_fqdn_current_branch}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>post</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>always</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// mark github commit as built
</span></span></span><span style=display:flex><span>      <span style=color:#000>publishStatusToGithub</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${currentBuild.currentResult}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>This directive is really difficult to read and eventually debug it</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;docker run -i --rm -v &#34;$PWD&#34;:/var/www/html/ -w /var/www/html/ project-test  /bin/bash -c &#34;composer install -a &amp;&amp; ./bin/phpunit -c /var/www/html/app/phpunit.xml --coverage-html /var/www/html/var/logs/coverage/ --log-junit /var/www/html/var/logs/phpunit.xml  --coverage-clover /var/www/html/var/logs/clover_coverage.xml&#34;&#39;</span>
</span></span></code></pre></div><p>Another way to write previous directive is to:</p><ul><li>use continuation line</li><li>avoid &lsquo;&&&rsquo; as it can mask errors, use &lsquo;;&rsquo; instead</li><li>use &lsquo;set -o errexit&rsquo; to fail on first error</li><li>use &lsquo;set -o pipefail&rsquo; to fail if eventual piped command is failing</li><li>&lsquo;set -x&rsquo; allows to trace every command executed for better debugging</li></ul><p>Here a possible refactoring:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  docker run -i --rm \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -v &#34;$PWD&#34;:/var/www/html/ \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    -w /var/www/html/ \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    project-test \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    /bin/bash -c &#34;\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      set -x ;\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      set -o errexit ;\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      set -o pipefail ;\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      composer install -a ;\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ./bin/phpunit \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        -c /var/www/html/app/phpunit.xml \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        --coverage-html /var/www/html/var/logs/coverage/ \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        --log-junit /var/www/html/var/logs/phpunit.xml  \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        --coverage-clover /var/www/html/var/logs/clover_coverage.xml
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>Note however it is best to use a separated sh file(s) that could take some parameters as it is simpler to read and to
eventually test separately. Here a refactoring using a separated sh file:</p><p>runTests.sh</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-bash data-lang=bash><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#204a87>set</span> -x -o errexit -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>composer install -a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./bin/phpunit <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -c /var/www/html/app/phpunit.xml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --coverage-html /var/www/html/var/logs/coverage/ <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --log-junit /var/www/html/var/logs/phpunit.xml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --coverage-clover /var/www/html/var/logs/clover_coverage.xml
</span></span></code></pre></div><p>jenkinsRunTests.sh</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-bash data-lang=bash><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#204a87>set</span> -x -o errexit -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build -t project-test <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>PWD</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/docker/test&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -i --rm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>PWD</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/var/www/html/&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -w /var/www/html/ <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  project-test <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  runTests.sh
</span></span></code></pre></div><p>Then the sh directive becomes simply</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;jenkinsRunTests.sh&#39;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ecd6072e7af2bd4a197a1087baeb6c77>7 - Annotated Jenkinsfiles - Part 3</h1><div class=lead>Additional Jenkinsfile pattern examples</div><h2 id=1-introduction>1. Introduction</h2><p>This build will:</p><ul><li>pull/build/push docker image used to generate project files</li><li>lint</li><li>run Unit tests with coverage</li><li>build the SPA</li><li>run accessibility tests</li><li>build story book and deploy it</li><li>deploy spa on s3 bucket and refresh cloudflare cache</li></ul><p>It allows to build for production and qa stages allowing different instances. Every build contains:</p><ul><li>a summary of the build<ul><li>git branch</li><li>git revision</li><li>target environment</li></ul></li><li>all the available Urls:<ul><li>spa url</li><li>storybook url</li></ul></li></ul><h2 id=2-annotated-jenkinsfile>2. Annotated Jenkinsfile</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>// anonymized parameters
</span></span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>credentialsId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;jenkinsCredentialId&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>library</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>identifier:</span> <span style=color:#4e9a06>&#39;jenkins_library@v1.0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>retriever:</span> <span style=color:#000>modernSCM</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>    <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;GitSCMSource&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>remote:</span> <span style=color:#4e9a06>&#39;git@github.com:fchastanet/jenkins-library.git&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>credentialsId:</span> <span style=color:#000>credentialsId</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>docker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>git</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Mail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>utils</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cloudflare</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Cloudflare</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// anonymized parameters
</span></span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>CLOUDFLARE_ZONE_ID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;cloudflareZoneId&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>CLOUDFLARE_ZONE_ID_PROD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;cloudflareZoneIdProd&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>REGISTRY_ID_QA</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;dockerRegistryId&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>REACT_APP_PENDO_API_KEY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;pendoApiKey&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>REGISTRY_QA</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REGISTRY_ID_QA</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.dkr.ecr.us-east-1.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>IMAGE_NAME_SPA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;project-ui&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>STAGING_API_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;https://api.host&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>INSTANCE_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;https://${params.instanceName}.host&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>REACT_APP_API_BASE_URL_PROD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;https://ui.host&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>REACT_APP_PENDO_SOURCE_DOMAIN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;https://cdn.eu.pendo.io&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>buildBucketPrefix</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>S3_PUBLIC_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;qa-spa.s3.amazonaws.com/project&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>S3_PROD_PUBLIC_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;spa.s3.amazonaws.com/project&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>instanceChoices</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>collect</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#39;project&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Map</span> <span style=color:#000>buildInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>apiUrl:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>storyBookAvailable:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>storyBookUrl:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>storyBookDocsUrl:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>spaAvailable:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>spaUrl:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>instanceName:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// add information on summary page
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>addBuildInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>deployInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spaAvailable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>String</span> <span style=color:#000>formatInstanceName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instanceName</span> <span style=color:#ce5c00;font-weight:700>?</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>&#34; (${buildInfo.instanceName})&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>deployInfo</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#4e9a06>&#34;&lt;a href=&#39;${buildInfo.spaUrl}&#39;&gt;SPA${formatInstanceName}&lt;/a&gt;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storyBookAvailable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>deployInfo</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#4e9a06>&#34; / &lt;a href=&#39;${buildInfo.storyBookUrl}&#39;&gt;Storybook&lt;/a&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>deployInfo</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#4e9a06>&#34; / &lt;a href=&#39;${buildInfo.storyBookDocsUrl}&#39;&gt;Storybook docs&lt;/a&gt;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>summaryHtml</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &lt;b&gt;branch : &lt;/b&gt;${GIT_BRANCH}&lt;br/&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &lt;b&gt;revision : &lt;/b&gt;${GIT_COMMIT}&lt;br/&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &lt;b&gt;target env : &lt;/b&gt;${params.targetEnv}&lt;br/&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    ${deployInfo}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>removeHtmlBadges</span> <span style=color:#f57900>id:</span> <span style=color:#4e9a06>&#34;htmlBadge${currentBuild.number}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>addHtmlBadge</span> <span style=color:#f57900>html:</span> <span style=color:#000>summaryHtml</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>id:</span> <span style=color:#4e9a06>&#34;htmlBadge${currentBuild.number}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// this image has the features docker and lighthouse
</span></span></span><span style=display:flex><span>      <span style=color:#000>label</span> <span style=color:#4e9a06>&#39;docker-base-ubuntu-lighthouse&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>gitParameter</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>branchFilter:</span> <span style=color:#4e9a06>&#39;origin/(.*)&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>defaultValue:</span> <span style=color:#4e9a06>&#39;main&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>quickFilterEnabled:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>sortMode:</span> <span style=color:#4e9a06>&#39;ASCENDING_SMART&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;BRANCH&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>type:</span> <span style=color:#4e9a06>&#39;PT_BRANCH&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>choice</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;targetEnv&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>choices:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;testing&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;production&#39;</span><span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Where it should be deployed to? (Default: none - No deploy)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>booleanParam</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;buildStorybook&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>defaultValue:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Build Storybook (will only apply if selected targetEnv is testing)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>choice</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;instanceName&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>choices:</span> <span style=color:#000>instanceChoices</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Instance name to deploy the revision&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Build SPA image&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// set build status to pending on github commit
</span></span></span><span style=display:flex><span>          <span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>([</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;GitHubSetCommitStatusBuilder&#39;</span><span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span>          <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>([</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;BuildUser&#39;</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#${currentBuild.number}_${BRANCH}_${BUILD_USER}_${targetEnv}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#000>branchName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagCompatibleFromBranch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000>shortSha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getShortCommitSha</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;production&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildBucketPrefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>GIT_COMMIT</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apiUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REACT_APP_API_BASE_URL_PROD</span>
</span></span><span style=display:flex><span>            <span style=color:#000>s3BaseUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;s3://project-spa/project&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildBucketPrefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instanceName</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instanceName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instanceName</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spaUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${INSTANCE_URL}/index.html&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apiUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STAGING_API_URL</span>
</span></span><span style=display:flex><span>            <span style=color:#000>s3BaseUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;s3://project-qa-spa/project&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storyBookUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${INSTANCE_URL}/storybook/index.html&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storyBookDocsUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${INSTANCE_URL}/storybook-docs/index.html&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000>addBuildInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// Setup .env
</span></span></span><span style=display:flex><span>          <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            set -x
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            echo &#34;REACT_APP_API_BASE_URL = &#39;${buildInfo.apiUrl}&#39;&#34; &gt; ./.env
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            echo &#34;REACT_APP_PENDO_SOURCE_DOMAIN = &#39;${REACT_APP_PENDO_SOURCE_DOMAIN}&#39;&#34; &gt;&gt; ./.env
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            echo &#34;REACT_APP_PENDO_API_KEY = &#39;${REACT_APP_PENDO_API_KEY}&#39;&#34; &gt;&gt; ./.env
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#000>withCredentials</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sshUserPrivateKey</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>credentialsId:</span> <span style=color:#4e9a06>&#39;sshCredentialsId&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>keyFileVariable:</span> <span style=color:#4e9a06>&#39;sshKeyFile&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullBuildPushImage</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>buildDirectory:</span>   <span style=color:#000>pwd</span><span style=color:#ce5c00;font-weight:700>(),</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// use safer way to inject ssh key during docker build
</span></span></span><span style=display:flex><span>              <span style=color:#f57900>buildArgs:</span> <span style=color:#4e9a06>&#34;--ssh default=\$sshKeyFile --build-arg USER_ID=\$(id -u)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>registryImageUrl:</span> <span style=color:#4e9a06>&#34;${REGISTRY_QA}/${IMAGE_NAME_SPA}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tagPrefix:</span>        <span style=color:#4e9a06>&#34;${IMAGE_NAME_SPA}:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>localTagName:</span>     <span style=color:#4e9a06>&#34;latest&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#000>shortSha</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>branchName</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>pullTags:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;main&#39;</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Linting&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          docker run --rm \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -v ${env.WORKSPACE}:/app \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -v /app/node_modules \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            ${IMAGE_NAME_SPA} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            npm run lint
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;UT&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;docker run --rm  \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -v ${env.WORKSPACE}:/app \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            -v /app/node_modules \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            ${IMAGE_NAME_SPA} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            npm run test:coverage -- --ci
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#000>junit</span> <span style=color:#4e9a06>&#39;output/junit.xml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// https://plugins.jenkins.io/clover/
</span></span></span><span style=display:flex><span>          <span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>            <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;CloverPublisher&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>cloverReportDir:</span> <span style=color:#4e9a06>&#39;output/coverage&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>cloverReportFileName:</span> <span style=color:#4e9a06>&#39;clover.xml&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>healthyTarget:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>methodCoverage:</span> <span style=color:#0000cf;font-weight:700>70</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>conditionalCoverage:</span> <span style=color:#0000cf;font-weight:700>70</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>statementCoverage:</span> <span style=color:#0000cf;font-weight:700>70</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// build will not fail but be set as unhealthy if coverage goes
</span></span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// below 60%
</span></span></span><span style=display:flex><span>            <span style=color:#f57900>unhealthyTarget:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>methodCoverage:</span> <span style=color:#0000cf;font-weight:700>60</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>conditionalCoverage:</span> <span style=color:#0000cf;font-weight:700>60</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>statementCoverage:</span> <span style=color:#0000cf;font-weight:700>60</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// build will fail if coverage goes below 50%
</span></span></span><span style=display:flex><span>            <span style=color:#f57900>failingTarget:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>methodCoverage:</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>conditionalCoverage:</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>statementCoverage:</span> <span style=color:#0000cf;font-weight:700>50</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Build SPA&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            docker run --rm \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              -v ${env.WORKSPACE}:/app \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              -v /app/node_modules \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              ${IMAGE_NAME_SPA}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Accessibility tests&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// the pa11y-ci could have been made available in the node image
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// to avoid installation each time, the build is launched
</span></span></span><span style=display:flex><span>          <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            sudo npm install -g serve pa11y-ci
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            serve -s build &gt; /dev/null 2&gt;&amp;1 &amp;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            pa11y-ci --threshold 5 http://127.0.0.1:3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Build Storybook&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>          <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;testing&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildStorybook</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              docker run --rm \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                -v ${env.WORKSPACE}:/app \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                -v /app/node_modules \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                ${IMAGE_NAME_SPA} \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                sh -c &#39;npm run storybook:build -- --output-dir build/storybook \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  &amp;&amp; npm run storybook:build-docs -- --output-dir build/storybook-docs&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storyBookAvailable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Artifacts to S3&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;production&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initAws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;arn:aws:iam::awsIamId:role/JenkinsSlave&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;aws s3 cp ${env.WORKSPACE}/build ${s3BaseUrl}/${buildBucketPrefix} --recursive --no-progress&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;aws s3 cp ${env.WORKSPACE}/build ${s3BaseUrl}/project1 --recursive --no-progress&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;production&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>echo</span> <span style=color:#4e9a06>&#39;project SPA packages have been pushed to production bucket.&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>echo</span> <span style=color:#4e9a06>&#39;&#39;&#39;You can refresh the production indexes with the CD
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              production pipeline.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>cloudflare</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>zonePurge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLOUDFLARE_ZONE_ID_PROD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#f57900>prefixes:</span><span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${S3_PROD_PUBLIC_URL}/project1/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>]])</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>cloudflare</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>zonePurge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLOUDFLARE_ZONE_ID</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#f57900>prefixes:</span><span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${S3_PUBLIC_URL}/${buildBucketPrefix}/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>]])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spaAvailable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>              <span style=color:#000>publishChecks</span> <span style=color:#f57900>detailsURL:</span> <span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spaUrl</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;projectSpaUrl&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#f57900>title:</span> <span style=color:#4e9a06>&#39;project SPA url&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>addBuildInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildInfo</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>post</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>always</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateConditionalGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendConditionalEmail</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-55c3c60a9f370d11db633ac258e1ebdc>8 - Annotated Jenkinsfiles - Part 4</h1><div class=lead>Complex Jenkinsfile scenarios</div><h2 id=1-introduction>1. introduction</h2><p>The project aim is to create a browser extension available on chrome and firefox</p><p>This build allows to:</p><ul><li>lint the project using megalinter and phpstorm inspection</li><li>build necessary docker images</li><li>build firefox and chrome extensions</li><li>deploy firefox extension on s3 bucket</li><li>deploy chrome extension on google play store</li></ul><h2 id=2-annotated-jenkinsfile>2. Annotated Jenkinsfile</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>credentialsId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;jenkinsSshCredentialsId&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>library</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>identifier:</span> <span style=color:#4e9a06>&#39;jenkins_library&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>retriever:</span> <span style=color:#000>modernSCM</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>        <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;GitSCMSource&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>remote:</span> <span style=color:#4e9a06>&#39;git@github.com:fchastanet/jenkins-library.git&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>credentialsId:</span> <span style=color:#000>credentialsId</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>docker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>git</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fchastanet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Mail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>new</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>deploymentBranchTagCompatible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>gitShortSha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>REGISTRY_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;dockerRegistryId.dkr.ecr.eu-west-1.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>ECR_BROWSER_EXTENSION_BUILD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;browser_extension_lint&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>BUILD_TAG</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;build&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>PHPSTORM_TAG</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;phpstorm-inspections&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>REFERENCE_JOB_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Browser_extension_deploy&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>FIREFOX_S3_BUCKET</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;browser-extensions&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// it would have been easier to use checkboxes to avoid &#39;both&#39;/&#39;none&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// complexity
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>DEPLOY_CHROME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetStore</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;both&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetStore</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;chrome&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>DEPLOY_FIREFOX</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetStore</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;both&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetStore</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;firefox&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>label</span> <span style=color:#4e9a06>&#39;docker-base-ubuntu&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>gitParameter</span> <span style=color:#f57900>branchFilter:</span> <span style=color:#4e9a06>&#39;origin/(.*)&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>defaultValue:</span> <span style=color:#4e9a06>&#39;master&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>quickFilterEnabled:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>sortMode:</span> <span style=color:#4e9a06>&#39;ASCENDING_SMART&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;BRANCH&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>type:</span> <span style=color:#4e9a06>&#39;PT_BRANCH&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>choice</span> <span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;targetStore&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>choices:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;both&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;chrome&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;firefox&#39;</span><span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Where it should be deployed to? (Default: none, has effect only on master branch)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>GOOGLE_CREDS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>credentials</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;GoogleApiChromeExtension&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>GOOGLE_TOKEN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>credentials</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;GoogleApiChromeExtensionCode&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>GOOGLE_APP_ID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;googleAppId&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// provided by https://addons.mozilla.org/en-US/developers/addon/api/key/
</span></span></span><span style=display:flex><span>    <span style=color:#000>FIREFOX_CREDS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>credentials</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;MozillaApiFirefoxExtension&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>FIREFOX_APP_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{d4ce8a6f-675a-4f74-b2ea-7df130157ff4}&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Init&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>deploymentBranchTagCompatible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTagCompatibleFromBranch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000>gitShortSha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getShortCommitSha</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Branch ${env.GIT_BRANCH}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Docker tag = ${deploymentBranchTagCompatible}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;git short sha = ${gitShortSha}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;echo StrictHostKeyChecking=no &gt;&gt; ~/.ssh/config&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lint&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>docker</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>image</span> <span style=color:#4e9a06>&#39;megalinter/megalinter-javascript:v5&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>args</span> <span style=color:#4e9a06>&#34;-u root -v ${WORKSPACE}:/tmp/lint --entrypoint=&#39;&#39;&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>reuseNode</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;npm install stylelint-config-rational-order&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>sh</span> <span style=color:#4e9a06>&#39;/entrypoint.sh&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Build docker images&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// whenOrSkip directive is defined in https://github.com/fchastanet/jenkins-library/blob/master/vars/whenOrSkip.groovy
</span></span></span><span style=display:flex><span>        <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentResult</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>docker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullBuildPushImage</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>buildDirectory:</span>   <span style=color:#4e9a06>&#39;build&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>registryImageUrl:</span> <span style=color:#4e9a06>&#34;${REGISTRY_URL}/${ECR_BROWSER_EXTENSION_BUILD}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tagPrefix:</span>        <span style=color:#4e9a06>&#34;${ECR_BROWSER_EXTENSION_BUILD}:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${BUILD_TAG}_${gitShortSha}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${BUILD_TAG}_${deploymentBranchTagCompatible}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>pullTags:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;${BUILD_TAG}_master&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Build firefox/chrome extensions&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentResult</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;SUCCESS&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                docker run \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  -v \$(pwd):/deploy \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  --rm &#39;${ECR_BROWSER_EXTENSION_BUILD}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  /deploy/build/build-extensions.sh
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// multiple git statuses can be set on a given commit
</span></span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// you can configure github to authorize pull request merge
</span></span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// based on the presence of one or more github statuses
</span></span></span><span style=display:flex><span>              <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;BUILD_OK&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deploy extensions&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// deploy both extensions in parallel
</span></span></span><span style=display:flex><span>      <span style=color:#000>parallel</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deploy chrome&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentResult</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;SUCCESS&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>DEPLOY_CHROME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// do not fail the entire build if this stage fail
</span></span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// so firefox stage can be executed
</span></span></span><span style=display:flex><span>              <span style=color:#000>catchError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#f57900>buildResult:</span> <span style=color:#4e9a06>&#39;SUCCESS&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>stageResult:</span> <span style=color:#4e9a06>&#39;FAILURE&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#8f5902;font-style:italic>// best practice: complex sh files have been created outside
</span></span></span><span style=display:flex><span>                  <span style=color:#8f5902;font-style:italic>// of this jenkinsfile deploy-chrome-extension.sh
</span></span></span><span style=display:flex><span>                  <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  docker run \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -v \$(pwd):/deploy \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e APP_CREDS_USR=&#39;${GOOGLE_CREDS_USR}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e APP_CREDS_PSW=&#39;${GOOGLE_CREDS_PSW}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e APP_TOKEN=&#39;${GOOGLE_APP_TOKEN}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e APP_ID=&#39;${GOOGLE_APP_ID}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      --rm &#39;${ECR_BROWSER_EXTENSION_BUILD}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      /deploy/build/deploy-chrome-extension.sh
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;CHROME_DEPLOYED&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deploy firefox&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>whenOrSkip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentResult</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;SUCCESS&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>DEPLOY_FIREFOX</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>catchError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#f57900>buildResult:</span> <span style=color:#4e9a06>&#39;SUCCESS&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>stageResult:</span> <span style=color:#4e9a06>&#39;FAILURE&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#8f5902;font-style:italic>// best practice: complex sh files have been created outside
</span></span></span><span style=display:flex><span>                  <span style=color:#8f5902;font-style:italic>// of this jenkinsfile deploy-firefox-extension.sh
</span></span></span><span style=display:flex><span>                  <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    docker run \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -v \$(pwd):/deploy \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e FIREFOX_JWT_ISSUER=&#39;${FIREFOX_CREDS_USR}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e FIREFOX_JWT_SECRET=&#39;${FIREFOX_CREDS_PSW}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      -e FIREFOX_APP_ID=&#39;${FIREFOX_APP_ID}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      --rm &#39;${ECR_BROWSER_EXTENSION_BUILD}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      /deploy/build/deploy-firefox-extension.sh
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>sh</span> <span style=color:#4e9a06>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    set -x
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    set -o errexit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    extensionVersion=&#34;\$(jq -r .version &lt; package.json)&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    extensionFilename=&#34;tools-\${extensionVersion}-an+fx.xpi&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    echo &#34;Upload new extension \${extensionFilename} to s3 bucket ${FIREFOX_S3_BUCKET}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3 cp &#34;\$(pwd)/packages/\${extensionFilename}&#34; &#34;s3://${FIREFOX_S3_BUCKET}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3api put-object-acl --bucket &#34;${FIREFOX_S3_BUCKET}&#34; --key &#34;\${extensionFilename}&#34; --acl public-read
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    # url is https://tools.s3.eu-west-1.amazonaws.com/tools-2.5.6-an%2Bfx.xpi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    echo &#34;Upload new version as current version&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3 cp &#34;\$(pwd)/packages/\${extensionFilename}&#34; &#34;s3://${FIREFOX_S3_BUCKET}/tools-an+fx.xpi&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3api put-object-acl --bucket &#34;${FIREFOX_S3_BUCKET}&#34; --key &#34;tools-an+fx.xpi&#34; --acl public-read
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    # url is https://tools.s3.eu-west-1.amazonaws.com/tools-an%2Bfx.xpi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    echo &#34;Upload updates.json file&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3 cp &#34;\$(pwd)/packages/updates.json&#34; &#34;s3://${FIREFOX_S3_BUCKET}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    aws s3api put-object-acl --bucket &#34;${FIREFOX_S3_BUCKET}&#34; --key &#34;updates.json&#34; --acl public-read
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    # url is https://tools.s3.eu-west-1.amazonaws.com/updates.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;FIREFOX_DEPLOYED&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>post</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>always</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>archiveArtifacts</span> <span style=color:#f57900>artifacts:</span> <span style=color:#4e9a06>&#39;report/mega-linter.log&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>archiveArtifacts</span> <span style=color:#f57900>artifacts:</span> <span style=color:#4e9a06>&#39;report/linters_logs/*&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>archiveArtifacts</span> <span style=color:#f57900>artifacts:</span> <span style=color:#4e9a06>&#39;packages/*&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>fingerprint:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>allowEmptyArchive:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// send email to the builder and culprits of the current commit
</span></span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// culprits are the committers since the last commit successfully built
</span></span></span><span style=display:flex><span>        <span style=color:#000>mail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendConditionalEmail</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>git</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateConditionalGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetStore</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;none&#39;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;origin/master&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// send an email to a teams channel so every collaborators knows
</span></span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// when a production ready extension has been deployed
</span></span></span><span style=display:flex><span>          <span style=color:#000>mail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendSuccessfulEmail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;teamsChannelId.onmicrosoft.com@amer.teams.ms&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e4ae12237c39b5f0feb5a0e7e96b8e95>9 - Annotated Jenkinsfiles - Part 5</h1><div class=lead>Advanced Jenkinsfile techniques</div><h2 id=1-introduction>1. introduction</h2><p>In jenkins library you can create your own directive that allows to generate jenkinsfile code. Here we will use this
feature to generate a complete Jenkinsfile.</p><h2 id=2-annotated-jenkinsfile>2. Annotated Jenkinsfile</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>library</span> <span style=color:#f57900>identifier:</span> <span style=color:#4e9a06>&#39;jenkins_library@v1.0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>retriever:</span> <span style=color:#000>modernSCM</span><span style=color:#ce5c00;font-weight:700>([</span>
</span></span><span style=display:flex><span>      <span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;GitSCMSource&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>remote:</span> <span style=color:#4e9a06>&#39;git@github.com:fchastanet/jenkins-library.git&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>credentialsId:</span> <span style=color:#4e9a06>&#39;jenkinsCredentialsId&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>djangoApiPipeline</span> <span style=color:#f57900>repoUrl:</span> <span style=color:#4e9a06>&#39;git@github.com:fchastanet/django_api_project.git&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#f57900>imageName:</span> <span style=color:#4e9a06>&#39;django_api&#39;</span>
</span></span></code></pre></div><h2 id=3-annotated-library-custom-directive>3. Annotated library custom directive</h2><p>In the jenkins library just add a file named <code>vars/djangoApiPipeline.groovy</code> with the following content</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env groovy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// content of your pipeline
</span></span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=4-annotated-library-custom-directive-djangoapipipelinegroovy>4. Annotated library custom directive djangoApiPipeline.groovy</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env groovy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>gitUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Git</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mailUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Mail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>dockerUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Docker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>kubernetesUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Kubernetes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>testUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tests</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>workerLabelNonProd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>workerLabelNonProd</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#4e9a06>&#39;eks-nonprod&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>workerLabelProd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>workerLabelProd</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#4e9a06>&#39;docker-ubuntu-prod-eks&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>awsRegionNonProd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workerLabelNonProd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;eks-nonprod&#39;</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#39;us-east-1&#39;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;eu-west-1&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>awsRegionProd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;eu-central-1&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>regionName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;prod&#39;</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>awsRegionProd</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>awsRegionNonProd</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>teamsEmail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>teamsEmail</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#4e9a06>&#39;teamsChannel.onmicrosoft.com@amer.teams.ms&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>String</span> <span style=color:#000>helmDirectory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>helmDirectory</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#4e9a06>&#39;./helm&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Boolean</span> <span style=color:#000>sendCortexMetrics</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>sendCortexMetrics</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Boolean</span> <span style=color:#000>skipTests</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>skipTests</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>  <span style=color:#000>List</span> <span style=color:#000>environments</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>environments</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;qa&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;prod&#39;</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Short</span> <span style=color:#000>skipBuild</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>pipeline</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>label</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;prod&#39;</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>workerLabelProd</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>workerLabelNonProd</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>gitParameter</span> <span style=color:#f57900>branchFilter:</span> <span style=color:#4e9a06>&#39;origin/(.*)&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#f57900>defaultValue:</span> <span style=color:#4e9a06>&#39;main&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#f57900>quickFilterEnabled:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#f57900>sortMode:</span> <span style=color:#4e9a06>&#39;ASCENDING_SMART&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;BRANCH&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#f57900>type:</span> <span style=color:#4e9a06>&#39;PT_BRANCH&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>choice</span> <span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;targetEnv&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>choices:</span> <span style=color:#000>environments</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Where it should be deployed to? (Default: none - No deploy)&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>string</span> <span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;instance&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>defaultValue:</span> <span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;&#39;&#39;The instance ID to define which QA instance it should
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        be deployed to (Will only apply if targetEnv is qa). Default is 1 for
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        CK and 01 for Darwin&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>booleanParam</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;suspendCron&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>defaultValue:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;Suspend cron jobs scheduling&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>choice</span> <span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>name:</span> <span style=color:#4e9a06>&#39;upStreamImage&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>choices:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;latest&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;beta&#39;</span><span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#f57900>description:</span> <span style=color:#4e9a06>&#39;&#39;&#39;Select beta to check if your build works with the
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        future version of the upstream image&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>stages</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Checkout from SCM&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Checking out from origin/${BRANCH} branch&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>gitUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>branchCheckout</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#4e9a06>&#39;babee6c1-14fe-4d90-9da0-ffa7068c69af&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>repoUrl</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#4e9a06>&#39;${BRANCH}&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>([</span><span style=color:#000>$class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;BuildUser&#39;</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>String</span> <span style=color:#000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#${currentBuild.number}_${BRANCH}_${BUILD_USER}_${targetEnv}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;qa&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;qe&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${displayName}_${instance}&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#000>currentBuild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>displayName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>displayName</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BUILD_TAG</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildDirectory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>buildDirectory</span> <span style=color:#ce5c00;font-weight:700>?</span>
</span></span><span style=display:flex><span>              <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildDirectory</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runCoverage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>runCoverage</span>
</span></span><span style=display:flex><span>            <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shortSha</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>gitUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getShortCommitSha</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GIT_BRANCH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>skipBuild</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dockerUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkImage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>shortSha</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Build&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>skipBuild</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>registryUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;dockerRegistryId.dkr.ecr.&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>              <span style=color:#000>awsRegionNonProd</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>buildDirectory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>?.</span><span style=color:#c4a000>buildDirectory</span> <span style=color:#ce5c00;font-weight:700>?:</span> <span style=color:#000>pwd</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>registryUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;dockerRegistryId.dkr.ecr.&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>awsRegionProd</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>dockerUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pullBuildImage</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>registryImageUrl:</span> <span style=color:#4e9a06>&#34;${registryUrl}/${args.imageName}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>pullTags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${params.targetEnv}&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>buildDirectory:</span> <span style=color:#4e9a06>&#34;${buildDirectory}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>buildArgs:</span> <span style=color:#4e9a06>&#34;--build-arg UPSTREAM_VERSION=${params.upStreamImage}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tagPrefix:</span> <span style=color:#4e9a06>&#34;${env.imageName}:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${env.shortSha}&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Test&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>skipBuild</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>skipTests</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>testUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execTests</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;Push&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;none&#39;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>//pipeline execution starting time for CD part
</span></span></span><span style=display:flex><span>            <span style=color:#000>Map</span> <span style=color:#000>argsMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[:]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>registryUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;registryIdProd.dkr.ecr.&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                <span style=color:#000>awsRegionProd</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>registryUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;registryIdNonProd.dkr.ecr.&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                <span style=color:#000>awsRegionNonProd</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;.amazonaws.com&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>argsMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>registryImageUrl:</span> <span style=color:#4e9a06>&#34;${registryUrl}/${args.imageName}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>pullTags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${env.shortSha}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>],</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tagPrefix:</span> <span style=color:#4e9a06>&#34;${registryUrl}/${args.imageName}:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>localTagName:</span> <span style=color:#4e9a06>&#34;${env.shortSha}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>tags:</span> <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${params.targetEnv}&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>skipBuild</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>dockerUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>promoteTag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsMap</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>argsMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pullTags&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>              <span style=color:#000>argsMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tagPrefix&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;${env.imageName}:&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>              <span style=color:#000>argsMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tags&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;${env.shortSha}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;${params.targetEnv}&#34;</span><span style=color:#ce5c00;font-weight:700>])</span>
</span></span><span style=display:flex><span>              <span style=color:#000>dockerUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tagPushImage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsMap</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deploy to Kubernetes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>when</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;none&#39;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>steps</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;prod&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// not sure it is a good practice as it forces the operator to
</span></span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// wait for build to reach this stage
</span></span></span><span style=display:flex><span>              <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#f57900>time:</span> <span style=color:#0000cf;font-weight:700>300</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#f57900>unit:</span> <span style=color:#4e9a06>&#34;SECONDS&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>                  <span style=color:#f57900>message:</span> <span style=color:#4e9a06>&#34;&#34;&#34;Do you want go ahead with ${env.shortSha}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  image tag for prod helm deploy?&#34;&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#f57900>ok:</span> <span style=color:#4e9a06>&#39;Yes&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>CHART_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>replaceAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>imageName</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;qa&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;qe&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>helmValueFilePath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${helmDirectory}&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;/value_files/values-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.yaml&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>NAMESPACE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${CHART_NAME}-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>helmValueFilePath</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${helmDirectory}&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;/value_files/values-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.yaml&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#000>NAMESPACE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${CHART_NAME}-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ingressUrl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>kubernetesUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIngressUrl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>helmValueFilePath</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Deploying into k8s..&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Helm release: ${CHART_NAME}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Target env: ${params.targetEnv}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;Url: ${ingressUrl}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>echo</span> <span style=color:#4e9a06>&#34;K8s namespace: ${NAMESPACE}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>kubernetesUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deployHelmChart</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>chartName:</span> <span style=color:#000>CHART_NAME</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>nameSpace:</span> <span style=color:#000>NAMESPACE</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>imageTag:</span> <span style=color:#4e9a06>&#34;${env.shortSha}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>helmDirectory:</span> <span style=color:#4e9a06>&#34;${helmDirectory}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#f57900>helmValueFilePath:</span> <span style=color:#000>helmValueFilePath</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>post</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>always</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>script</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>gitUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateGithubCommitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${currentBuild.currentResult}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;${env.WORKSPACE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000>mailUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendConditionalEmail</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetEnv</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;prod&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#000>mailUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sendTeamsNotification</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>teamsEmail</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=5-final-thoughts-about-this-technique>5. Final thoughts about this technique</h2><p>This technique is really useful when you have a lot of similar projects reusing over and over the same pipeline. It
allows:</p><ul><li>code reuse</li><li>avoid duplicated code</li><li>easier maintenance</li></ul><p>However it has the following drawbacks:</p><ul><li>some projects using this generic pipeline could have specific needs<ul><li>eg 1: not the same way to run unit tests, to overcome that issue the method <code>testUtil.execTests</code> is used allowing to
run a specific sh file if it exists</li><li>eg 2: more complex way to launch docker environment</li><li>&mldr;</li></ul></li><li><strong>be careful</strong>, when you upgrade this jenkinsfile as all the projects using it will be upgraded at once<ul><li>it could be seen as an advantage, but it is also a big risk as it could impact all the prod environment at once</li><li>to overcome that issue I suggest to use library versioning when using the jenkins library in your project pipeline
Eg: check <a href=#2-annotated-jenkinsfile>Annotated Jenkinsfile</a> <code>@v1.0</code> when cloning library project</li></ul></li><li>I highly suggest to use a unit test framework of the library to avoid at most bad surprises</li></ul><p>In conclusion, I&rsquo;m still not sure it is a best practice to generate pipelines like this.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-495ca42bdd947744d65cf04377598dfb>10 - Jenkins Recipes and Tips</h1><div class=lead>Common recipes and troubleshooting tips</div><ul><li><a href=#1-jenkins-snippet-generator>1. Jenkins snippet generator</a></li><li><a href=#2-declarative-pipeline-allows-you-to-restart-a-build-from-a-given-stage>2. Declarative pipeline allows you to restart a build from a given stage</a></li><li><a href=#3-replay-a-pipeline>3. Replay a pipeline</a></li><li><a href=#4-vs-code-jenkinsfile-validation>4. VS code Jenkinsfile validation</a></li><li><a href=#5-how-to-chain-pipelines->5. How to chain pipelines ?</a></li><li><a href=#6-viewing-pipelines-hierarchy>6. Viewing pipelines hierarchy</a></li></ul><h2 id=1-jenkins-snippet-generator>1. Jenkins snippet generator</h2><p>Use jenkins snippet generator by adding <code>/pipeline-syntax/</code> to your jenkins pipeline. to allow you to generate jenkins
pipeline code easily with inline doc. It also list the available variables.</p><p><img src=images/snippetGenerator.png alt="jenkins snippet generator"></p><h2 id=2-declarative-pipeline-allows-you-to-restart-a-build-from-a-given-stage>2. Declarative pipeline allows you to restart a build from a given stage</h2><p><img src=images/restartFromStage.png alt="restart from stage"></p><h2 id=3-replay-a-pipeline>3. Replay a pipeline</h2><p>Replaying a pipeline allows you to update your jenkinsfile before replaying the pipeline, easier debugging !
<img src=images/replayPipeline.png alt="replay a pipeline"></p><h2 id=4-vs-code-jenkinsfile-validation>4. VS code Jenkinsfile validation</h2><p>Please follow this documentation
<a href=https://github.com/fchastanet/coding_dojo_jenkins/blob/master/Exercise03%20-%20Full%20pipeline.md#step-01b---enable-jenkins-pipeline-linter-in-vscode>enable jenkins pipeline linter in vscode</a></p><h2 id=5-how-to-chain-pipelines->5. How to chain pipelines ?</h2><p>Simply use the <code>build</code> directive followed by the name of the build to launch</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;display:grid><code class=language-groovy data-lang=groovy><span style=display:flex;background-color:#dfdfdf><span><span style=color:#000>build</span> <span style=color:#4e9a06>&#39;OtherBuild&#39;</span>
</span></span></code></pre></div><h2 id=6-viewing-pipelines-hierarchy>6. Viewing pipelines hierarchy</h2><p>The <a href=https://plugins.jenkins.io/downstream-buildview/>downstream-buildview plugin</a> allows to view the full chain of
dependent builds.</p><p><img src=https://raw.githubusercontent.com/jenkins-infra/plugins-wiki-docs/master/downstream-buildview/docs/images/downstream-buildview_screen1.JPG alt="Jenkins Downstream Build Pipeline Visualization"></p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/fchastanet aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Bash Tools Framework" aria-label="Bash Tools Framework"><a target=_blank rel=noopener href=https://fchastanet.github.io/bash-tools-framework/ aria-label="Bash Tools Framework"><i class="fas fa-toolbox"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Bash Tools" aria-label="Bash Tools"><a target=_blank rel=noopener href=https://fchastanet.github.io/bash-tools/ aria-label="Bash Tools"><i class="fas fa-tools"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Bash Dev Env" aria-label="Bash Dev Env"><a target=_blank rel=noopener href=https://fchastanet.github.io/bash-dev-env/ aria-label="Bash Dev Env"><i class="fas fa-laptop-code"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Bash Compiler" aria-label="Bash Compiler"><a target=_blank rel=noopener href=https://fchastanet.github.io/bash-compiler/ aria-label="Bash Compiler"><i class="fas fa-cogs"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2026
<span class=td-footer__authors>Francois Chastanet</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://github.com/fchastanet/my-documents/blob/master/LICENSE target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/my-documents/js/main.min.65d702cee0bf35691ed701b78b7b713d03be4a9f1f184f95e8049d065c07bc57.js integrity="sha256-ZdcCzuC/NWke1wG3i3txPQO+Sp8fGE+V6ASdBlwHvFc=" crossorigin=anonymous></script><script defer src=/my-documents/js/click-to-copy.min.24576ff9fe9f85bb1948ecae52ce227cafce53757a3ad52301f2a79260f6b97d.js integrity="sha256-JFdv+f6fhbsZSOyuUs4ifK/OU3V6OtUjAfKnkmD2uX0=" crossorigin=anonymous></script><script src=/my-documents/js/tabpane-persist.js></script></body></html>